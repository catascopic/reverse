<!DOCTYPE html>
<html lang="en" onkeydown="shortcut(event)">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reverse Voice Recorder</title>
<style>

audio {
	display: block;
}

#record {
	width: 8em;
	background-color: red;
	color: white;
	border: 0;
	padding: 4px;
	border-radius: 4px;
}

</style>
</head>
<body>

<div class="container">
	<h1>Reverse Voice Recorder</h1>
	<button id="record" onclick="toggleRecord()">⏺ Record</button>
	<div id="clips"></div>
</div>

<script>

const recordButton = document.getElementById('record');
const clips = document.getElementById('clips');

let mediaRecorder;
let isRecording = false;

async function toggleRecord() {
	if (isRecording) {
		mediaRecorder.stop();
		isRecording = false;
		recordButton.textContent = "⏺ Record";
	} else {
		let audioChunks = [];
		let stream = await navigator.mediaDevices.getUserMedia({audio: true});
		mediaRecorder = new MediaRecorder(stream);
		mediaRecorder.start();
		isRecording = true;
		recordButton.textContent = "⏹ Stop";
		mediaRecorder.ondataavailable = function(e) {
			audioChunks.push(e.data);
		};
		mediaRecorder.onstop = function() {
			reverseAudio(audioChunks);
		};
	}
}

async function reverseAudio(audioChunks) {
	let audioBlob = new Blob(audioChunks, {type: 'audio/webm'});
	let arrayBuffer = await audioBlob.arrayBuffer();
	let audioBuffer = await new AudioContext().decodeAudioData(arrayBuffer);

	for (let i = 0; i < audioBuffer.numberOfChannels; i++) {
		Array.prototype.reverse.call(audioBuffer.getChannelData(i));
	}

	let offlineContext = new OfflineAudioContext(
		audioBuffer.numberOfChannels,
		audioBuffer.length,
		audioBuffer.sampleRate);
	let reversedSource = offlineContext.createBufferSource();
	reversedSource.buffer = audioBuffer;
	reversedSource.connect(offlineContext.destination);
	reversedSource.start();

	let renderedBuffer = await offlineContext.startRendering();
	let audioSrc = URL.createObjectURL(bufferToWavBlob(renderedBuffer));
	
	let clipContainer = document.createElement('div');
	
	let audio = document.createElement('audio');
	audio.src = audioSrc;
	audio.controls = true;
	clipContainer.appendChild(audio);
	
	let downloadLink = document.createElement('a');
	downloadLink.href = audioSrc;
	let filename = `${new Date().toISOString()}.wav`;
	downloadLink.textContent = 'Download WAV';
	downloadLink.download = filename;
	clipContainer.appendChild(downloadLink);
	
	let deleteButton = document.createElement('button');
	deleteButton.onclick = function() {
		clipContainer.remove();
	};
	deleteButton.textContent = '❌';
	clipContainer.appendChild(deleteButton);
	
	clips.prepend(clipContainer)
	
	audio.play();
}

function bufferToWavBlob(buffer) {
	let numberOfChannels = buffer.numberOfChannels;
	let len = buffer.length * numberOfChannels * 2 + 44;
	let view = new DataView(new ArrayBuffer(len));

	// Write WAV header
	writeString(view, 0, 'RIFF');
	view.setUint32(4, len - 8, true);
	writeString(view, 8, 'WAVE');
	writeString(view, 12, 'fmt ');
	view.setUint32(16, 16, true);
	view.setUint16(20, 1, true);
	view.setUint16(22, numberOfChannels, true);
	view.setUint32(24, buffer.sampleRate, true);
	view.setUint32(28, buffer.sampleRate * 4, true);
	view.setUint16(32, numberOfChannels * 2, true);
	view.setUint16(34, 16, true);
	writeString(view, 36, 'data');
	view.setUint32(40, len - 44, true);

	// Write interleaved PCM data
	let offset = 44;
	for (let i = 0; i < buffer.length; i++) {
		for (let channel = 0; channel < numberOfChannels; channel++) {
			let sample = Math.max(-1, Math.min(1, buffer.getChannelData(channel)[i]));
			view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
			offset += 2;
		}
	}
	return new Blob([view], {type: 'audio/wav'});
}

function writeString(view, offset, string) {
	for (let i = 0; i < string.length; i++) {
		view.setUint8(offset + i, string.charCodeAt(i));
	}
}

function shortcut(e) {
	if (e.key == ' ') {
		e.preventDefault();
		toggleRecord();
	} else if (e.key == '1') {
		setPlaybackRate(1);
	} else if (e.key == '2') {
		setPlaybackRate(0.5);
	} else if (e.key == 'p') {
		clips.querySelector('audio').play();
	}
}

function setPlaybackRate(rate) {
	for (let audio of document.getElementsByTagName('audio')) {
		audio.playbackRate = rate;
	}
}

</script>
</body>
</html>
